name: iOS Reviews Import - hourly

on:
  schedule:
    - cron: '10 */4 * * *'   # a cada 4h no minuto 10 (UTC)
  workflow_dispatch:

concurrency:
  group: reviews-ios
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Import iOS reviews
        env:
          IOS_APP_ID:        ${{ secrets.IOS_APP_ID }}
          IMPORT_TOKEN:      ${{ secrets.IMPORT_TOKEN }}
          WORKER_URL:        ${{ secrets.WORKER_URL }}         # ex.: https://reviews-bot...workers.dev
          WORKER_IMPORT_URL: ${{ secrets.WORKER_IMPORT_URL }}  # se usar endpoint dedicado
          IOS_PAGES:  2
          LOCALE:     br
          COUNTRY:    br
          LANG:       pt_BR
        run: node ios-index.mjs

      - name: Generate AI suggestions (iOS)
        env:
          TOKEN:      ${{ secrets.IMPORT_TOKEN }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
        run: |
          set -euo pipefail
          curl --fail-with-body -sS -X POST "$WORKER_URL/api/ai/suggest-batch?platform=ios&limit=40" \
               -H "Authorization: Bearer $TOKEN" \
               -H "Content-Type: application/json"
