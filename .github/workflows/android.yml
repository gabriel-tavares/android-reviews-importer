name: Android Reviews Import - hourly

on:
  schedule:
    - cron: '20 */4 * * *'   # a cada 4h no minuto 20 (UTC)
  workflow_dispatch:

concurrency:
  group: reviews-android
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Import Android reviews
        env:
          ANDROID_APP_ID:      ${{ secrets.ANDROID_APP_ID }}
          IMPORT_TOKEN:        ${{ secrets.IMPORT_TOKEN }}
          WORKER_URL:          ${{ secrets.WORKER_URL }}
          WORKER_IMPORT_URL:   ${{ secrets.WORKER_IMPORT_URL }}  # ex.: https://reviews-bot.../api/import/android
          LANG:       pt_BR
          COUNTRY:    br
        run: node index.mjs

      - name: Generate AI suggestions (Android)
        env:
          TOKEN:      ${{ secrets.IMPORT_TOKEN }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          run: |
            set -euo pipefail
            curl --fail-with-body -sS -X POST "$WORKER_URL/api/ai/suggest-batch?platform=ios&limit=40" \
                 -H "Authorization: Bearer $TOKEN" \
                 -H "Content-Type: application/json"
